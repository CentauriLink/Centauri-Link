#:import dp kivy.metrics.dp

# =========================================================
#  CentauriLink FINAL KV (FIXED TextInput visibility)
#  - IP text ALWAYS visible (TextField container approach)
#  - Smaller button text so labels fit
#  - Rounded corners everywhere
#  - Button text stays inside buttons
# =========================================================

# --- Button base: text stays inside, centered, visible (smaller font) ---
<WrapButton@Button>:
    background_color: 0,0,0,0
    color: 1,1,1,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    line_height: 1.0

<GradientButton@WrapButton>:
    size_hint_y: None
    height: dp(48)
    font_size: "13sp"
    canvas.before:
        Color:
            rgba: 0.12,0.65,0.85,1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]

<SecondaryButton@WrapButton>:
    size_hint_y: None
    height: dp(46)
    font_size: "12sp"
    color: 0.92,0.94,0.96,1
    canvas.before:
        Color:
            rgba: 0.18,0.22,0.28,1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

<ClickableImage@ButtonBehavior+Image>:
    allow_stretch: True
    keep_ratio: True

<TogglePill@ToggleButton>:
    size_hint_y: None
    height: dp(46)
    background_color: 0,0,0,0
    color: 1,1,1,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    canvas.before:
        Color:
            rgba: (0.12,0.65,0.85,1) if self.state == "down" else (0.18,0.22,0.28,1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

<CircularButton@WrapButton>:
    size_hint: None, None
    size: dp(44), dp(44)
    padding: 0, 0
    text_size: self.size
    font_size: "11sp"
    canvas.before:
        Color:
            rgba: (0.12,0.65,0.85,1) if self.state == 'down' else (0.20,0.24,0.30,1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [22]

<Card@BoxLayout>:
    orientation: "vertical"
    padding: dp(14)
    spacing: dp(10)
    size_hint_y: None
    height: self.minimum_height
    canvas.before:
        Color:
            rgba: 0.10,0.12,0.15,1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [18]

<ScreenRoot@BoxLayout>:
    orientation: "vertical"
    padding: dp(14)
    spacing: dp(12)
    canvas.before:
        Color:
            rgba: 0.03,0.04,0.06,1
        Rectangle:
            pos: self.pos
            size: self.size

<Header@BoxLayout>:
    size_hint_y: None
    height: dp(84)
    spacing: dp(12)
    padding: dp(8)
    Image:
        source: "assets/logo.png"
        size_hint_x: None
        width: dp(64)
        allow_stretch: True
        keep_ratio: True
    BoxLayout:
        orientation: "vertical"
        spacing: 2
        size_hint_y: None
        height: self.minimum_height
        Label:
            text: "CentauriLink"
            font_size: "20sp"
            bold: True
            color: 0.95,0.98,1,1
            size_hint_y: None
            height: self.texture_size[1]
        Label:
            text: "Elegoo Centauri Carbon"
            font_size: "13sp"
            color: 0.7,0.78,0.86,1
            size_hint_y: None
            height: self.texture_size[1]

# =========================================================
# FIXED INPUT: draw background with container, TextInput is transparent
# =========================================================
<TextField@BoxLayout>:
    size_hint_y: None
    height: dp(50)
    padding: dp(12), dp(10)
    canvas.before:
        Color:
            rgba: 0.12,0.14,0.18,1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]

# Keep TextInput neutral (no global canvas / no hidden textures)
<TextInput>:
    # hard-disable default textures
    background_normal: ""
    background_active: ""
    background_disabled_normal: ""
    background_disabled_active: ""
    background_color: 0,0,0,0

    # text visibility
    foreground_color: 1,1,1,1
    cursor_color: 0.12,0.65,0.85,1
    selection_color: 0.12,0.65,0.85,0.35
    hint_text_color: 0.60,0.66,0.74,1

    font_size: "15sp"
    write_tab: False
    padding: 0, 0

# Style any plain Button (device list etc.)
<Button>:
    background_color: 0,0,0,0
    color: 0.92,0.94,0.96,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    canvas.before:
        Color:
            rgba: 0.16,0.19,0.24,1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [14]


# ---------------- HOME ----------------
<HomeScreen>:
    ScreenRoot:
        ScrollView:
            do_scroll_x: False
            bar_width: dp(6)
            GridLayout:
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(12)
                padding: dp(4)

                Header:

                Card:
                    Label:
                        text: "Printer Temperatures"
                        font_size: "16sp"
                        bold: True
                        color: 1,1,1,1
                        size_hint_y: None
                        height: self.texture_size[1]

                    GridLayout:
                        cols: 1
                        spacing: dp(8)
                        size_hint_y: None
                        height: self.minimum_height

                        BoxLayout:
                            orientation: "vertical"
                            size_hint_y: None
                            height: dp(56)
                            Label:
                                text: "Nozzle • " + app.nozzle_temp + "°C"
                                size_hint_y: None
                                height: dp(20)
                                color: 0.95,0.98,1,1
                            ProgressBar:
                                max: 300
                                value: app.nozzle_value

                        BoxLayout:
                            orientation: "vertical"
                            size_hint_y: None
                            height: dp(56)
                            Label:
                                text: "Build Plate • " + app.bed_temp + "°C"
                                size_hint_y: None
                                height: dp(20)
                                color: 0.95,0.98,1,1
                            ProgressBar:
                                max: 120
                                value: app.bed_value

                        BoxLayout:
                            orientation: "vertical"
                            size_hint_y: None
                            height: dp(56)
                            Label:
                                text: "Chamber • " + app.chamber_temp + "°C"
                                size_hint_y: None
                                height: dp(20)
                                color: 0.95,0.98,1,1
                            ProgressBar:
                                max: 120
                                value: app.chamber_value

                Card:
                    size_hint_y: None
                    height: dp(310)
                    Label:
                        text: "Live Camera"
                        font_size: "16sp"
                        bold: True
                        color: 1,1,1,1
                        size_hint_y: None
                        height: self.texture_size[1]

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(250)

                        Image:
                            id: camera_view
                            source: ""
                            allow_stretch: True
                            keep_ratio: True
                            size_hint: 1, 1
                            pos_hint: {"center_x":0.5, "center_y":0.5}
                            canvas.before:
                                Color:
                                    rgba: 0.06,0.07,0.09,1
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [14]

                        BoxLayout:
                            orientation: "vertical"
                            size_hint: None, None
                            pos_hint: {"right":0.99, "y":0.02}
                            width: dp(160)
                            height: dp(108)
                            spacing: dp(8)
                            GradientButton:
                                text: "Play / Reload"
                                height: dp(46)
                                on_release: root.start_camera()
                            SecondaryButton:
                                text: "Open in Browser"
                                height: dp(46)
                                on_release: app.root.get_screen('print').open_camera_in_browser()

                Card:
                    Label:
                        text: "Printer Status"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                    GridLayout:
                        cols: 1
                        spacing: dp(6)
                        size_hint_y: None
                        height: self.minimum_height

                        Label:
                            text: "State: " + app.print_state
                            size_hint_y: None
                            height: dp(22)
                        BoxLayout:
                            size_hint_y: None
                            height: dp(36)
                            Label:
                                size_hint_x: None
                                width: dp(110)
                                text: "Progress:"
                            ProgressBar:
                                max: 100
                                value: app.print_progress
                        Label:
                            text: "Layer: " + (app.print_layer if app.print_layer else "-") + " / " + (app.print_total_layer if app.print_total_layer else "-")
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Coords: " + app.coords
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Lights: " + app.light_state
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Updated: " + app.status_timestamp
                            size_hint_y: None
                            height: dp(22)

                BoxLayout:
                    size_hint_y: None
                    height: dp(56)
                    spacing: dp(10)
                    GradientButton:
                        text: "Open Print Control"
                        on_release: app.root.current = "print"
                    SecondaryButton:
                        text: "Settings"
                        on_release: app.root.current = "settings"


# ---------------- PRINT ----------------
<PrintScreen>:
    ScreenRoot:
        ScrollView:
            do_scroll_x: False
            bar_width: dp(6)
            GridLayout:
                cols: 1
                spacing: dp(12)
                size_hint_y: None
                height: self.minimum_height
                padding: dp(4)

                Header:

                Card:
                    Label:
                        text: root.status_text
                        font_size: "14sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                # FIXED IP INPUT (TextField container)
                BoxLayout:
                    size_hint_y: None
                    height: dp(50)
                    spacing: dp(10)

                    TextField:
                        TextInput:
                            id: manual_ip
                            hint_text: "Enter printer IP / hostname"
                            multiline: False
                            halign: "left"
                            cursor_width: dp(2)

                            # Force visible text
                            foreground_color: 1,1,1,1
                            hint_text_color: 0.60,0.66,0.74,1
                            cursor_color: 0.12,0.65,0.85,1
                            selection_color: 0.12,0.65,0.85,0.35

                            # Kill background textures (again, explicit)
                            background_normal: ""
                            background_active: ""
                            background_disabled_normal: ""
                            background_disabled_active: ""
                            background_color: 0,0,0,0

                            font_size: "15sp"
                            padding: 0, 0
                            write_tab: False

                    GradientButton:
                        text: "Add / Select"
                        size_hint_x: None
                        width: dp(150)
                        on_release: root.add_manual_printer(manual_ip.text)

                BoxLayout:
                    size_hint_y: None
                    height: dp(52)
                    spacing: dp(10)
                    GradientButton:
                        text: "Connect (Auto)"
                        on_release: root.connect_printer()
                    TogglePill:
                        id: auto_poll
                        text: "Auto Poll"
                        on_state: root.toggle_auto_poll(True if self.state == 'down' else False)

                Card:
                    Label:
                        text: "Fan Controls"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                    GridLayout:
                        cols: 1
                        spacing: dp(10)
                        size_hint_y: None
                        height: self.minimum_height

                        BoxLayout:
                            size_hint_y: None
                            height: dp(56)
                            spacing: dp(10)
                            Label:
                                text: "Model Fan"
                                size_hint_x: None
                                width: dp(120)
                            TogglePill:
                                id: model_toggle
                                text: "On / Off"
                                size_hint_x: None
                                width: dp(96)
                                on_state: root.on_fan_toggle("ModelFan", True if self.state == 'down' else False)
                            Slider:
                                id: model_slider
                                min: 0
                                max: 100
                                value: 0
                            CircularButton:
                                text: "Set"
                                on_release: root.set_fan_speed("ModelFan", int(model_slider.value))

                        BoxLayout:
                            size_hint_y: None
                            height: dp(56)
                            spacing: dp(10)
                            Label:
                                text: "Aux Fan"
                                size_hint_x: None
                                width: dp(120)
                            TogglePill:
                                id: aux_toggle
                                text: "On / Off"
                                size_hint_x: None
                                width: dp(96)
                                on_state: root.on_fan_toggle("AuxiliaryFan", True if self.state == 'down' else False)
                            Slider:
                                id: aux_slider
                                min: 0
                                max: 100
                                value: 0
                            CircularButton:
                                text: "Set"
                                on_release: root.set_fan_speed("AuxiliaryFan", int(aux_slider.value))

                        BoxLayout:
                            size_hint_y: None
                            height: dp(56)
                            spacing: dp(10)
                            Label:
                                text: "Box Fan"
                                size_hint_x: None
                                width: dp(120)
                            TogglePill:
                                id: box_toggle
                                text: "On / Off"
                                size_hint_x: None
                                width: dp(96)
                                on_state: root.on_fan_toggle("BoxFan", True if self.state == 'down' else False)
                            Slider:
                                id: box_slider
                                min: 0
                                max: 100
                                value: 0
                            CircularButton:
                                text: "Set"
                                on_release: root.set_fan_speed("BoxFan", int(box_slider.value))

                Card:
                    size_hint_y: None
                    height: dp(170)
                    Label:
                        text: "Manual Printers"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                    ScrollView:
                        size_hint_y: None
                        height: dp(126)
                        do_scroll_x: False
                        GridLayout:
                            id: device_list
                            cols: 1
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(8)

                Card:
                    Label:
                        text: "Live Status (last)"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                    GridLayout:
                        cols: 1
                        spacing: dp(6)
                        size_hint_y: None
                        height: self.minimum_height

                        Label:
                            text: "Selected: " + (root.selected_ip if root.selected_ip else "(none)")
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Temperature: " + root.current_temp
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "State: " + app.print_state
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Progress: {}%".format(int(app.print_progress))
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Coords: " + app.coords
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Lights: " + app.light_state
                            size_hint_y: None
                            height: dp(22)
                        Label:
                            text: "Updated: " + app.status_timestamp
                            size_hint_y: None
                            height: dp(22)

                BoxLayout:
                    size_hint_y: None
                    height: dp(56)
                    spacing: dp(10)
                    SecondaryButton:
                        text: "Home"
                        on_release: app.root.current = "home"
                    SecondaryButton:
                        text: "Camera"
                        on_release: root.open_camera_in_browser()
                    SecondaryButton:
                        text: "Disconnect"
                        on_release: root.disconnect_printer()


# ---------------- SETTINGS ----------------
<SettingsScreen>:
    ScreenRoot:
        ScrollView:
            do_scroll_x: False
            bar_width: dp(6)
            GridLayout:
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(12)
                padding: dp(4)

                Header:

                Card:
                    Label:
                        text: "Settings"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]
                    Label:
                        text: "WebSocket: ws://<IP>:3030/websocket"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.75,0.82,0.9,1
                    Label:
                        text: "HTTP fallback polling supported"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.75,0.82,0.9,1
                    Label:
                        text: "Support: work.dewandeljack@gmail.com"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.75,0.82,0.9,1

                Card:
                    Label:
                        text: "Donate"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]
                    Label:
                        text: "Paypal: work.dewandeljack@gmail.com"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.75,0.82,0.9,1
                    Label:
                        text: "IBAN: BE60 7507 1070 0570"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.75,0.82,0.9,1
                Card:
                    Label:
                        text: "Links"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]
                    GradientButton:
                        text: "Open License"
                        on_release: app.open_license()
                    SecondaryButton:
                        text: "Open GitHub"
                        on_release: app.open_github()

                Card:
                    Label:
                        text: "Partners"
                        font_size: "16sp"
                        bold: True
                        size_hint_y: None
                        height: self.texture_size[1]

                    ClickableImage:
                        source: "assets/Partner1.png"
                        size_hint_y: None
                        height: dp(80)
                        on_release:
                            app.open_url("https://octoeverywhere.com")

                BoxLayout:
                    size_hint_y: None
                    height: dp(56)
                    spacing: dp(10)
                    SecondaryButton:
                        text: "Back"
                        on_release: app.root.current = "home"
