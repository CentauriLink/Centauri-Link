#:import dp kivy.metrics.dp

# =========================================================
#  CentauriLink - FINAL KV (Sleek Dark + Bottom Nav) UPDATED
#  - REMOVED: Fan Controls card
#  - REMOVED: Live Camera display card (home)
#  - Logo: assumes the PNG itself is already rounded (no extra rounding/mask)
# =========================================================

# ---------------- Base widgets ----------------

<WrapButton@Button>:
    background_color: 0,0,0,0
    color: 1,1,1,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    line_height: 1.0

<PrimaryButton@WrapButton>:
    size_hint_y: None
    height: dp(48)
    font_size: "13sp"
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [18]
        Color:
            rgba: 0.06, 0.70, 0.95, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [18]
        Color:
            rgba: 0.10, 0.35, 0.95, 0.55
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [18]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 18,18,18,18)
            width: 1.1

<SecondaryButton@WrapButton>:
    size_hint_y: None
    height: dp(46)
    font_size: "12sp"
    color: 0.92,0.95,0.98,1
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [16]
        Color:
            rgba: 0.11,0.13,0.18,0.92
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16,16,16,16)
            width: 1.0

<TogglePill@ToggleButton>:
    size_hint_y: None
    height: dp(46)
    background_color: 0,0,0,0
    color: 1,1,1,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [16]
        Color:
            rgba: (0.10,0.75,0.98,0.95) if self.state == "down" else (0.11,0.13,0.18,0.92)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16,16,16,16)
            width: 1.0

<CircularButton@WrapButton>:
    size_hint: None, None
    size: dp(44), dp(44)
    padding: 0, 0
    text_size: self.size
    font_size: "11sp"
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [22]
        Color:
            rgba: 0.11,0.13,0.18,0.92
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [22]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 22,22,22,22)
            width: 1.0

<Card@BoxLayout>:
    orientation: "vertical"
    padding: dp(14)
    spacing: dp(10)
    size_hint_y: None
    height: self.minimum_height
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(3)
            size: self.size
            radius: [20]
        Color:
            rgba: 0.10,0.12,0.17,0.82
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [20]
        Color:
            rgba: 1,1,1,0.05
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 20,20,20,20)
            width: 1.0

<ScreenRoot@BoxLayout>:
    orientation: "vertical"
    padding: dp(14)
    spacing: dp(12)
    canvas.before:
        Color:
            rgba: 0.03,0.04,0.06,1
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: 0.06,0.10,0.20,0.55
        Rectangle:
            pos: self.x, self.y + self.height*0.45
            size: self.width, self.height*0.55
        Color:
            rgba: 0.10,0.65,0.95,0.18
        Ellipse:
            pos: self.x - dp(80), self.y + self.height - dp(220)
            size: dp(320), dp(320)
        Color:
            rgba: 0.30,0.25,0.95,0.14
        Ellipse:
            pos: self.right - dp(260), self.y + self.height*0.35
            size: dp(320), dp(320)
        Color:
            rgba: 0.10,0.95,0.70,0.10
        Ellipse:
            pos: self.x - dp(120), self.y - dp(160)
            size: dp(360), dp(360)

<Header@BoxLayout>:
    size_hint_y: None
    height: dp(92)
    padding: dp(10)
    spacing: dp(12)
    canvas.before:
        Color:
            rgba: 0,0,0,0.40
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [22]
        Color:
            rgba: 0.10,0.12,0.17,0.70
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [22]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 22,22,22,22)
            width: 1.0

    Image:
        source: "assets/logo.png"
        size_hint: None, None
        size: dp(62), dp(62)
        allow_stretch: True
        keep_ratio: True


    BoxLayout:
        orientation: "vertical"
        spacing: dp(2)
        Label:
            text: "CentauriLink"
            font_size: "20sp"
            bold: True
            color: 0.95,0.98,1,1
            size_hint_y: None
            height: self.texture_size[1]
        Label:
            text: "Elegoo Centauri Carbon"
            font_size: "13sp"
            color: 0.70,0.78,0.86,1
            size_hint_y: None
            height: self.texture_size[1]

    Widget:
<TextField@BoxLayout>:
    size_hint_y: None
    height: dp(50)
    padding: dp(12), dp(10)
    canvas.before:
        Color:
            rgba: 0.11,0.13,0.18,0.92
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16,16,16,16)
            width: 1.0

<TextInput>:
    background_normal: ""
    background_active: ""
    background_disabled_normal: ""
    background_disabled_active: ""
    background_color: 0,0,0,0
    foreground_color: 1,1,1,1
    cursor_color: 0.10,0.70,0.95,1
    selection_color: 0.10,0.70,0.95,0.35
    hint_text_color: 0.60,0.66,0.74,1
    font_size: "15sp"
    write_tab: False
    padding: 0, 0

<Button>:
    background_color: 0,0,0,0
    color: 0.92,0.94,0.96,1
    bold: True
    font_size: "12sp"
    padding: dp(14), dp(10)
    text_size: self.width - dp(24), None
    halign: "center"
    valign: "middle"
    shorten: True
    shorten_from: "right"
    canvas.before:
        Color:
            rgba: 0,0,0,0.45
        RoundedRectangle:
            pos: self.x, self.y - dp(2)
            size: self.size
            radius: [16]
        Color:
            rgba: 0.11,0.13,0.18,0.92
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16,16,16,16)
            width: 1.0

<ClickableImage@ButtonBehavior+Image>:
    allow_stretch: True
    keep_ratio: True


# ---------------- Bottom Navigation ----------------

<BottomNav@BoxLayout>:
    active: ""   # "home" / "print" / "octo" / "settings"
    size_hint_y: None
    height: dp(78)
    padding: dp(12), dp(10)
    spacing: dp(10)
    canvas.before:
        Color:
            rgba: 0,0,0,0.55
        RoundedRectangle:
            pos: self.x, self.y - dp(3)
            size: self.size
            radius: [22]
        Color:
            rgba: 0.10,0.12,0.17,0.92
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [22]
    canvas.after:
        Color:
            rgba: 1,1,1,0.10
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 22,22,22,22)
            width: 1.0

<NavItem@ButtonBehavior+BoxLayout>:
    nav: None
    screen_name: ""
    icon_source: ""
    label_text: ""
    orientation: "vertical"
    spacing: dp(4)
    padding: dp(8), dp(8)
    size_hint: 1, 1

    canvas.before:
        Color:
            rgba: (0.10,0.70,0.95,0.22) if (root.nav and root.nav.active == root.screen_name) else (0,0,0,0)
        RoundedRectangle:
            pos: self.x + dp(6), self.y + dp(6)
            size: self.width - dp(12), self.height - dp(12)
            radius: [18]

    Image:
        source: root.icon_source
        size_hint: None, None
        size: dp(22), dp(22)
        allow_stretch: True
        keep_ratio: True
        opacity: 1 if (root.nav and root.nav.active == root.screen_name) else 0.85
        pos_hint: {"center_x": 0.5}

    Label:
        text: root.label_text
        font_size: "11sp"
        bold: True
        color: (0.92,0.95,0.98,1) if (root.nav and root.nav.active == root.screen_name) else (0.70,0.78,0.88,1)
        size_hint_y: None
        height: dp(14)
        halign: "center"
        valign: "middle"
        text_size: self.size


# ---------------- HOME ----------------

<HomeScreen>:
    ScreenRoot:
        BoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                GridLayout:
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(12)
                    padding: dp(4)

                    Header:

                    Card:
                        Label:
                            text: "Printer Temperatures"
                            font_size: "16sp"
                            bold: True
                            color: 1,1,1,1
                            size_hint_y: None
                            height: self.texture_size[1]

                        GridLayout:
                            cols: 1
                            spacing: dp(10)
                            size_hint_y: None
                            height: self.minimum_height

                            BoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(60)
                                Label:
                                    text: "Nozzle • " + app.nozzle_temp + "°C"
                                    size_hint_y: None
                                    height: dp(22)
                                    color: 0.95,0.98,1,1
                                    bold: True
                                ProgressBar:
                                    max: 300
                                    value: app.nozzle_value

                            BoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(60)
                                Label:
                                    text: "Build Plate • " + app.bed_temp + "°C"
                                    size_hint_y: None
                                    height: dp(22)
                                    color: 0.95,0.98,1,1
                                    bold: True
                                ProgressBar:
                                    max: 120
                                    value: app.bed_value

                            BoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(60)
                                Label:
                                    text: "Chamber • " + app.chamber_temp + "°C"
                                    size_hint_y: None
                                    height: dp(22)
                                    color: 0.95,0.98,1,1
                                    bold: True
                                ProgressBar:
                                    max: 120
                                    value: app.chamber_value

                    # REMOVED: Live Camera card

                    Card:
                        Label:
                            text: "Printer Status"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        GridLayout:
                            cols: 1
                            spacing: dp(8)
                            size_hint_y: None
                            height: self.minimum_height

                            Label:
                                text: "State: " + app.print_state
                                size_hint_y: None
                                height: dp(22)
                                color: 0.92,0.95,0.98,1

                            BoxLayout:
                                size_hint_y: None
                                height: dp(36)
                                Label:
                                    size_hint_x: None
                                    width: dp(110)
                                    text: "Progress:"
                                    color: 0.78,0.86,0.95,1
                                ProgressBar:
                                    max: 100
                                    value: app.print_progress

                            Label:
                                text: "Layer: " + (app.print_layer if app.print_layer else "-") + " / " + (app.print_total_layer if app.print_total_layer else "-")
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1

                            Label:
                                text: "Coords: " + app.coords
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1

                            Label:
                                text: "Lights: " + app.light_state
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1

                            Label:
                                text: "Updated: " + app.status_timestamp
                                size_hint_y: None
                                height: dp(22)
                                color: 0.60,0.70,0.82,1

            BottomNav:
                id: nav_home
                active: "home"
                NavItem:
                    nav: nav_home
                    screen_name: "home"
                    icon_source: "assets/icons/home.png"
                    label_text: "Home"
                    on_release: app.root.current = "home"
                NavItem:
                    nav: nav_home
                    screen_name: "print"
                    icon_source: "assets/icons/control.png"
                    label_text: "Control"
                    on_release: app.root.current = "print"
                NavItem:
                    nav: nav_home
                    screen_name: "octo"
                    icon_source: "assets/icons/octo.png"
                    label_text: "Octo"
                    on_release: app.root.current = "octo"
                NavItem:
                    nav: nav_home
                    screen_name: "settings"
                    icon_source: "assets/icons/settings.png"
                    label_text: "Settings"
                    on_release: app.root.current = "settings"


# ---------------- PRINT / CONTROL ----------------

<PrintScreen>:
    ScreenRoot:
        BoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                GridLayout:
                    cols: 1
                    spacing: dp(12)
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(4)

                    Header:

                    Card:
                        Label:
                            text: root.status_text
                            font_size: "13sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]
                            color: 0.92,0.95,0.98,1

                    BoxLayout:
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)

                        TextField:
                            TextInput:
                                id: manual_ip
                                hint_text: "Enter printer IP / hostname"
                                multiline: False
                                halign: "left"
                                cursor_width: dp(2)

                        PrimaryButton:
                            text: "Add / Select"
                            size_hint_x: None
                            width: dp(150)
                            on_release: root.add_manual_printer(manual_ip.text)

                    BoxLayout:
                        size_hint_y: None
                        height: dp(52)
                        spacing: dp(10)
                        PrimaryButton:
                            text: "Connect (Auto)"
                            on_release: root.connect_printer()
                        TogglePill:
                            id: auto_poll
                            text: "Auto Poll"
                            on_state: root.toggle_auto_poll(True if self.state == 'down' else False)

                    # REMOVED: Fan Controls card

                    Card:
                        size_hint_y: None
                        height: dp(180)
                        Label:
                            text: "Manual Printers"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        ScrollView:
                            size_hint_y: None
                            height: dp(136)
                            do_scroll_x: False
                            GridLayout:
                                id: device_list
                                cols: 1
                                size_hint_y: None
                                height: self.minimum_height
                                spacing: dp(8)

                    Card:
                        Label:
                            text: "Live Status (last)"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        GridLayout:
                            cols: 1
                            spacing: dp(7)
                            size_hint_y: None
                            height: self.minimum_height

                            Label:
                                text: "Selected: " + (root.selected_ip if root.selected_ip else "(none)")
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "Temperature: " + root.current_temp
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "State: " + app.print_state
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "Progress: {}%".format(int(app.print_progress))
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "Coords: " + app.coords
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "Lights: " + app.light_state
                                size_hint_y: None
                                height: dp(22)
                                color: 0.78,0.86,0.95,1
                            Label:
                                text: "Updated: " + app.status_timestamp
                                size_hint_y: None
                                height: dp(22)
                                color: 0.60,0.70,0.82,1

                    Card:
                        Label:
                            text: "Quick Actions"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        BoxLayout:
                            size_hint_y: None
                            height: dp(52)
                            spacing: dp(10)
                            SecondaryButton:
                                text: "Camera (Browser)"
                                on_release: root.open_camera_in_browser()
                            SecondaryButton:
                                text: "Disconnect"
                                on_release: root.disconnect_printer()

            BottomNav:
                id: nav_print
                active: "print"
                NavItem:
                    nav: nav_print
                    screen_name: "home"
                    icon_source: "assets/icons/home.png"
                    label_text: "Home"
                    on_release: app.root.current = "home"
                NavItem:
                    nav: nav_print
                    screen_name: "print"
                    icon_source: "assets/icons/control.png"
                    label_text: "Control"
                    on_release: app.root.current = "print"
                NavItem:
                    nav: nav_print
                    screen_name: "octo"
                    icon_source: "assets/icons/octo.png"
                    label_text: "Octo"
                    on_release: app.root.current = "octo"
                NavItem:
                    nav: nav_print
                    screen_name: "settings"
                    icon_source: "assets/icons/settings.png"
                    label_text: "Settings"
                    on_release: app.root.current = "settings"


# ---------------- OCTO (EMPTY TAB FOR LATER) ----------------

<OctoScreen>:
    ScreenRoot:
        BoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                GridLayout:
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(12)
                    padding: dp(4)

                    Header:

                    Card:
                        Label:
                            text: "OctoEverywhere"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        Label:
                            text: "Reserved tab for OctoEverywhere linking (coming soon)."
                            color: 0.70,0.78,0.88,1
                            size_hint_y: None
                            height: self.texture_size[1] + dp(8)

                        SecondaryButton:
                            text: "Open OctoEverywhere Website"
                            on_release: app.open_url("https://octoeverywhere.com")

            BottomNav:
                id: nav_octo
                active: "octo"
                NavItem:
                    nav: nav_octo
                    screen_name: "home"
                    icon_source: "assets/icons/home.png"
                    label_text: "Home"
                    on_release: app.root.current = "home"
                NavItem:
                    nav: nav_octo
                    screen_name: "print"
                    icon_source: "assets/icons/control.png"
                    label_text: "Control"
                    on_release: app.root.current = "print"
                NavItem:
                    nav: nav_octo
                    screen_name: "octo"
                    icon_source: "assets/icons/octo.png"
                    label_text: "Octo"
                    on_release: app.root.current = "octo"
                NavItem:
                    nav: nav_octo
                    screen_name: "settings"
                    icon_source: "assets/icons/settings.png"
                    label_text: "Settings"
                    on_release: app.root.current = "settings"


# ---------------- SETTINGS ----------------

<SettingsScreen>:
    ScreenRoot:
        BoxLayout:
            orientation: "vertical"
            spacing: dp(12)

            ScrollView:
                do_scroll_x: False
                bar_width: dp(6)

                GridLayout:
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(12)
                    padding: dp(4)

                    Header:

                    Card:
                        Label:
                            text: "Settings"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        Label:
                            text: "WebSocket: ws://<IP>:3030/websocket"
                            size_hint_y: None
                            height: dp(20)
                            color: 0.70,0.80,0.92,1

                        Label:
                            text: "HTTP fallback polling supported"
                            size_hint_y: None
                            height: dp(20)
                            color: 0.70,0.80,0.92,1

                        Label:
                            text: "Support: work.dewandeljack@gmail.com"
                            size_hint_y: None
                            height: dp(20)
                            color: 0.70,0.80,0.92,1

                    Card:
                        Label:
                            text: "Donate"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        Label:
                            text: "Paypal: work.dewandeljack@gmail.com"
                            size_hint_y: None
                            height: dp(20)
                            color: 0.70,0.80,0.92,1

                        Label:
                            text: "IBAN: BE60 7507 1070 0570"
                            size_hint_y: None
                            height: dp(20)
                            color: 0.70,0.80,0.92,1

                    Card:
                        Label:
                            text: "Links"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        PrimaryButton:
                            text: "Open License"
                            on_release: app.open_url("https://github.com/CentauriLink/Centauri-Link?tab=License-1-ov-file#readme")

                        SecondaryButton:
                            text: "Open GitHub"
                            on_release: app.open_url("https://github.com/CentauriLink/Centauri-Link")

                    Card:
                        Label:
                            text: "Partners"
                            font_size: "16sp"
                            bold: True
                            size_hint_y: None
                            height: self.texture_size[1]

                        BoxLayout:
                            size_hint_y: None
                            height: dp(92)
                            padding: dp(10)
                            spacing: dp(10)
                            canvas.before:
                                Color:
                                    rgba: 0.11,0.13,0.18,0.92
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [18]
                            ClickableImage:
                                source: "assets/Partner1.png"
                                size_hint_x: None
                                width: dp(170)
                                on_release: app.open_url("https://octoeverywhere.com")

            BottomNav:
                id: nav_settings
                active: "settings"
                NavItem:
                    nav: nav_settings
                    screen_name: "home"
                    icon_source: "assets/icons/home.png"
                    label_text: "Home"
                    on_release: app.root.current = "home"
                NavItem:
                    nav: nav_settings
                    screen_name: "print"
                    icon_source: "assets/icons/control.png"
                    label_text: "Control"
                    on_release: app.root.current = "print"
                NavItem:
                    nav: nav_settings
                    screen_name: "octo"
                    icon_source: "assets/icons/octo.png"
                    label_text: "Octo"
                    on_release: app.root.current = "octo"
                NavItem:
                    nav: nav_settings
                    screen_name: "settings"
                    icon_source: "assets/icons/settings.png"
                    label_text: "Settings"
                    on_release: app.root.current = "settings"
